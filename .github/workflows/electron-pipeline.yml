name: Electron Pipeline

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (optionnel, auto-calculée si vide)'
        required: false
        type: string
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'test/**'
      - 'package.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main]

jobs:
  # ========================================
  # ÉTAPE 1: Build Electron (avec tests intégrés)
  # ========================================
  build:
    name: Build
    uses: ./.github/workflows/electron-build.yml
    with:
      version: ${{ github.event.inputs.version || '' }}
    secrets:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

  # ========================================
  # ÉTAPE 2: Tests E2E macOS
  # ========================================
  test-e2e:
    name: E2E Tests
    needs: [build]
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/test-e2e-macos.yml
    with:
      artifact_name: juni-electron-macos
    secrets: {}

  # ========================================
  # ÉTAPE 3: Pre-release GitHub (AUTOMATIQUE)
  # ========================================
  pre-release:
    name: Pre-release
    needs: [build, test-e2e]
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/release-github.yml
    with:
      version: ${{ needs.build.outputs.version }}-beta.${{ github.run_number }}
      artifact_name: juni-electron-macos
    secrets: inherit

  # ========================================
  # ÉTAPE 4: Résumé final
  # ========================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build, test-e2e, pre-release]
    if: always()

    steps:
      - name: Pipeline Summary
        run: |
          echo "======================================"
          echo "RÉSUMÉ DE LA PIPELINE"
          echo "======================================"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Étapes:"
          echo "  1. Build: ${{ needs.build.result }}"
          echo "  2. Tests E2E: ${{ needs.test-e2e.result }}"
          echo "  3. Pre-release: ${{ needs.pre-release.result }}"

          echo ""

          E2E_RESULT="${{ needs.test-e2e.result }}"
          if [[ "${{ needs.build.result }}" == "success" && \
                ("$E2E_RESULT" == "success" || "$E2E_RESULT" == "skipped") ]]; then
            echo "PIPELINE RÉUSSIE!"
            echo ""
            echo "Application testée et prête:"
            echo "  - ZIP Universal: juni-electron-macos"
            echo "  - Version de base: ${{ needs.build.outputs.version }}"

            if [[ "${{ needs.pre-release.result }}" == "success" ]]; then
              echo ""
              if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                echo "PRE-RELEASE CRÉÉE MANUELLEMENT"
              else
                echo "PRE-RELEASE CRÉÉE AUTOMATIQUEMENT"
              fi
              echo ""
              echo "Tag: v${{ needs.build.outputs.version }}-beta.${{ github.run_number }}"
              echo "URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build.outputs.version }}-beta.${{ github.run_number }}"
              echo ""
              echo "PROMOTION PRODUCTION MANUELLE"
              echo ""
              echo "Pour promouvoir en production:"
              echo "  1. Tester la pre-release ci-dessus"
              echo "  2. Aller dans Actions > Promote Release to Production"
              echo "  3. Cliquer sur 'Run workflow'"
              echo "  4. Entrer le tag: v${{ needs.build.outputs.version }}-beta.${{ github.run_number }}"
              echo "  5. Cliquer 'Run workflow'"
            elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo ""
              echo "PULL REQUEST - Pas de pre-release créée"
              echo ""
              echo "Les artifacts sont disponibles pendant 7 jours pour tests."
            fi
          else
            echo "PIPELINE ÉCHOUÉE"
            echo "Vérifiez les étapes en échec ci-dessus."
            exit 1
          fi
