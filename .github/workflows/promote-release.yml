name: Promote Release to Production

permissions:
  contents: write
  actions: read

on:
  workflow_dispatch:
    inputs:
      prerelease_tag:
        description: 'Tag de la pre-release à promouvoir (ex: v2.572.92-beta.123)'
        required: true
        type: string

jobs:
  promote:
    name: Promote to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: extract-version
        run: |
          TAG="${{ github.event.inputs.prerelease_tag }}"

          # Enlever le 'v' du début si présent
          VERSION="${TAG#v}"

          # Extraire la version de base (enlever -beta.X)
          BASE_VERSION=$(echo "$VERSION" | sed 's/-beta\.[0-9]*$//')

          echo "Tag pre-release: $TAG"
          echo "Version finale: $BASE_VERSION"

          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Download ZIP from pre-release
        run: |
          TAG="${{ github.event.inputs.prerelease_tag }}"

          echo "Téléchargement du ZIP depuis la pre-release $TAG..."

          mkdir -p zip-release

          gh release download "$TAG" \
            --pattern "*.zip" \
            --dir zip-release

          echo "Fichiers téléchargés:"
          ls -lh zip-release/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        run: |
          VERSION="${{ steps.extract-version.outputs.base_version }}"

          echo "# Juni Electron v$VERSION" > release-notes.md
          echo "" >> release-notes.md
          echo "## Installation" >> release-notes.md
          echo "" >> release-notes.md
          echo "### macOS" >> release-notes.md
          echo "Téléchargez le fichier ZIP ci-dessous, décompressez-le et glissez Juni.app dans Applications." >> release-notes.md
          echo "Ce build universel fonctionne sur:" >> release-notes.md
          echo "- **Apple Silicon** (M1/M2/M3/M4)" >> release-notes.md
          echo "- **Intel**" >> release-notes.md
          echo "" >> release-notes.md
          echo "## Auto-update" >> release-notes.md
          echo "" >> release-notes.md
          echo "Les mises à jour sont automatiques via Squirrel.Mac." >> release-notes.md
          echo "" >> release-notes.md
          echo "## Changements" >> release-notes.md
          echo "" >> release-notes.md

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "### Commits depuis $LAST_TAG" >> release-notes.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> release-notes.md
          else
            echo "### Commits récents" >> release-notes.md
            git log -10 --pretty=format:"- %s (%h)" >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "*Release promue depuis pre-release ${{ github.event.inputs.prerelease_tag }}*" >> release-notes.md

      - name: Create final release
        run: |
          VERSION="${{ steps.extract-version.outputs.base_version }}"
          TAG="v$VERSION"

          echo "Création de la release finale: $TAG"

          gh release create "$TAG" \
            --title "Juni Electron v$VERSION" \
            --notes-file release-notes.md \
            zip-release/*.zip

          echo "Release finale créée: https://github.com/${{ github.repository }}/releases/tag/$TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete pre-release
        run: |
          TAG="${{ github.event.inputs.prerelease_tag }}"

          echo "Suppression de la pre-release: $TAG"

          gh release delete "$TAG" --yes

          echo "Pre-release supprimée (libère le stockage GitHub)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Promotion Summary
        run: |
          VERSION="${{ steps.extract-version.outputs.base_version }}"

          echo "PROMOTION RÉUSSIE!"
          echo ""
          echo "Release finale créée: v$VERSION"
          echo "  https://github.com/${{ github.repository }}/releases/tag/v$VERSION"
          echo ""
          echo "Pre-release supprimée: ${{ github.event.inputs.prerelease_tag }}"
          echo ""
          echo "L'auto-update Squirrel va distribuer cette version aux utilisateurs."
