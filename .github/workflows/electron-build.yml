name: Electron Build macOS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use (optional, auto-calculated if empty)'
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version to use (optional, auto-calculated if empty)'
        required: false
        type: string
    secrets:
      APPLE_ID:
        required: true
      APPLE_APP_SPECIFIC_PASSWORD:
        required: true
      APPLE_TEAM_ID:
        required: true
      CSC_LINK:
        required: true
      CSC_KEY_PASSWORD:
        required: true
    outputs:
      version:
        description: "Version calculee"
        value: ${{ jobs.version.outputs.version }}
      artifact_name:
        description: "Nom de l'artifact ZIP"
        value: juni-electron-macos

jobs:
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gitversion.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Version
        id: gitversion
        uses: w7k-io/w7k-io-gh/gitversion@main

  test:
    name: Unit Tests
    uses: ./.github/workflows/test-components.yml
    secrets: {}

  build:
    name: Build macOS Universal
    needs: [version, test]
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Update version locally
        run: npm version ${{ inputs.version || needs.version.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Import Code Signing Certificate
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          echo "$CSC_LINK" | base64 --decode > certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import certificate.p12 -k $KEYCHAIN_PATH -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychains -d user -s $KEYCHAIN_PATH
          security default-keychain -s $KEYCHAIN_PATH
          rm certificate.p12
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: Build with Electron Forge (make)
        run: npm run make
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      - name: Verify code signing
        run: |
          ZIP_FILE=$(find out/make/zip -name "*.zip" | head -n 1)
          echo "Verifying code signing for: $ZIP_FILE"

          TEMP_DIR=$(mktemp -d)
          unzip -q "$ZIP_FILE" -d "$TEMP_DIR"
          APP_PATH=$(find "$TEMP_DIR" -name "Kagron.app" -maxdepth 2 | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "Could not find Kagron.app in ZIP"
            rm -rf "$TEMP_DIR"
            exit 1
          fi

          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          spctl --assess --type execute --verbose "$APP_PATH"

          rm -rf "$TEMP_DIR"
          echo "App is properly signed and notarized"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: juni-electron-macos
          path: out/make/zip/**/*.zip
          retention-days: 7
          if-no-files-found: error

      - name: Cleanup keychain
        if: always()
        run: |
          security default-keychain -s ~/Library/Keychains/login.keychain-db || true
          if [ -n "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          fi

      - name: Summary
        run: |
          ZIP_FILE=$(find out/make/zip -name "*.zip" | head -n 1)
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Universal (ARM64 + x64) |" >> $GITHUB_STEP_SUMMARY
          echo "| ZIP | $(basename "$ZIP_FILE") |" >> $GITHUB_STEP_SUMMARY
          echo "| Size | $(ls -lh "$ZIP_FILE" | awk '{print $5}') |" >> $GITHUB_STEP_SUMMARY
